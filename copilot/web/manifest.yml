# copilot/web/manifest.yml
name: web
type: Load Balanced Web Service

http:
  path: "/"
  healthcheck:
    path: "/healthz"
    success_codes: "200-399"
    interval: 10s
    timeout: 5s
    healthy_threshold: 2
    unhealthy_threshold: 5
    grace_period: 120s
  #alias:
  # - tasks.joshuascutts.com
  #certificates:
  # - arn:aws:acm:ap-southeast-2:427004120763:certificate/3c65de84-38f1-42de-8f93-46c9e7df944f
  #redirect_to_https: true

image:
  build:
    dockerfile: ./Dockerfile
    context: .
  port: 1337
  command:
    - sh
    - -lc
    - |
      set -e
      mkdir -p /data/user-avatars /data/project-background-images /data/attachments
      # one-time migration if folders exist as real dirs (not symlinks)
      for d in user-avatars project-background-images; do
        if [ -d "/app/public/$d" ] && [ ! -L "/app/public/$d" ]; then
          cp -R /app/public/$d/* "/data/$d/" 2>/dev/null || true
          rm -rf "/app/public/$d"
        fi
      done
      if [ -d "/app/private/attachments" ] && [ ! -L "/app/private/attachments" ]; then
        cp -R /app/private/attachments/* /data/attachments/ 2>/dev/null || true
        rm -rf /app/private/attachments
      fi
      ln -sfn /data/user-avatars /app/public/user-avatars
      ln -sfn /data/project-background-images /app/public/project-background-images
      ln -sfn /data/attachments /app/private/attachments
      npm run start:prod

port: 1337

cpu: 256
memory: 512
count: 1
exec: true

variables:
  BASE_URL: https://tasks.joshuascutts.com
  TRUST_PROXY: "true"
  PGSSLMODE: require
  PGSSLROOTCERT: /app/certs/rds-bundle.pem
  NODE_EXTRA_CA_CERTS: /app/certs/rds-bundle.pem
  KNEX_REJECT_UNAUTHORIZED_SSL_CERTIFICATE: "false"
  NODE_ENV: production
  PORT: 1337
  HOST: 0.0.0.0

  SMTP_HOST: smtp.mailgun.org
  SMTP_PORT: "587"
  SMTP_SECURE: "false"
  SMTP_FROM: "Tasks <josh@joshuascutts.com>"
  SMTP_NAME: "tasks.joshuascutts.com"

  # If your image has the RDS bundle baked in, you can also add:
  # NODE_EXTRA_CA_CERTS: /app/certs/rds-global-bundle.pem
  # PGSSLROOTCERT: /app/certs/rds-global-bundle.pem

secrets:
  DATABASE_URL: /copilot/planka/prod/secrets/DATABASE_URL
  SECRET_KEY:   /copilot/planka/prod/secrets/SECRET_KEY
  SMTP_USER: /copilot/planka/prod/secrets/SMTP_USER
  SMTP_PASSWORD: /copilot/planka/prod/secrets/SMTP_PASSWORD

# Persist uploads so avatars/backgrounds/attachments survive new tasks
storage:
  volumes:
    data:
      path: /data
      read_only: false
      efs: true
